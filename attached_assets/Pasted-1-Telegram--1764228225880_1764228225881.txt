1) Общая цель

Сделать сайт/админку и Telegram-бота полностью рабочими, согласованными по логике и стилю, с надёжными «снэпшотами» (бэкапами/восстановлением), корректной работой фотографий, корректной логикой формирования «вуншбола» (wunsch-bowl), и корректной интеграцией с Railway (prod DB & storage). Код — в едином стиле, без «костылей».

2) Админка — снэпшоты (backup / restore)

Требование: реализовать функциональность «Снэпшоты», которая полностью сохраняет и полностью восстанавливает текущее состояние сайта.

Что сохранить в одном снэпшоте

Полная дампа базы данных (структура + данные).

Все статические файлы: Public/Main/Media и другие медиа.

Конфигурации админки (настройки страниц, меню, категории, варианты и т.д.).

Любые файлы локального хранилища (если есть).

Требования к реализации

Добавить в админку кнопку/страницу: Создать снэпшот и Список снэпшотов с возможностью восстановления.

Формат: единый архив (например, .zip), внутри:

db_dump.sql (или формат DB dump).

media/ (вся папка Public/Main/Media).

config.json (с основными настройками админки).

Хранение: возможность сохранять локально на Railway storage / S3 / выбранный storage. Для Railway — использовать привязанный storage или выгрузку в безопасное место.

Restore должен:

Остановить кратковременно запись в БД (транзакционно или временно отключить запись).

Очистить/перезаписать данные БД дампом.

Перезаписать Public/Main/Media.

Пересчитать индексы/кэш (если есть).

Реализовать API: POST /admin/snapshots/create, GET /admin/snapshots, POST /admin/snapshots/:id/restore.

Логирование действий, авторизация — только админ может создавать/восстанавливать.

Покрыть автоматическими тестами (unit/integration) базовый сценарий: create -> list -> restore.

Критерии приёмки

Созданный снэпшот можно скачать и вручную распаковать: внутри — db и media.

Восстановление из снэпшота возвращает состояние сайта полностью (проверить на тестовой среде).

Документация в админке: короткая инструкция «как создать/восстановить».

3) Фотографии — единое хранилище и автоматическое привязывание

Проблема: фотографии не отображаются корректно на проде (Railway), визуально на сайте — разброс, на главном слайдере есть 3 картинки, остальные отсутствуют.

Что реализовать

Все изображения хранятся в едином месте: Public/Main/Media/ (существующая папка).

В БД для каждого блюда/страницы должно быть поле image_path (строка) и, при необходимости, image_alt.

Скрипт/миграция для массового связывания изображений по имени файла:

Для каждого блюда/категории искать файл в Public/Main/Media по slug, title или ожидаемому имени.

Поддерживать сопоставление с учётом немецких и английских названий: реализовать маппинг/сопоставление (case-insensitive, заменить пробелы/спецсимволы на _).

Если имя файла отличается, переименовать файл в media/<entity_slug>.<ext> или сохранить мап в БД.

Интерфейс в админке: «Привязать/Перепривязать изображение» с возможностью автозаполнения (кнопка «Автовыбор по имени»).

При развёртывании на Railway: убедиться, что Public/Main/Media деплоится/синхронизируется с прод-сториджем. Если Railway использует отдельный файловый слой, настроить загрузку в постоянное хранилище (S3, Railway storage) и хранить URL в image_path.

При добавлении фото через админку — сохранять в одном формате и обновлять image_path так, чтобы URL работал и на Replit, и на Railway.

Доп. требования

Сжатие/оптимизация изображений на сервере при загрузке (optional but recommended).

Фallback: если изображение отсутствует — показывать заглушку, но логировать отсутствие.

Критерии приёмки

Автоматическая привязка по имени: 90%+ совпадений без ручного вмешательства.

При загрузке на Railway — все изображения доступны по URL, одинаково на Replit и Railway.

Главный слайдер и страницы блюд показывают соответствующие изображения.

4) Логика «вуншбол» (wunschbowl) — цены и extras

Проблемы: неправильное вычисление цен, при добавлении в корзину цена = 0€, данные о составе не отправляются в Telegram.

Бизнес-логика (чётко)

Вуншбол состоит из нескольких секций: тип (client ABP / standard ABP), размер, протеин (protein), база, соусы, маринады, экстра (добавки).

У каждого продукта/ингредиента:

есть базовая цена для продукта как отдельного блюда (price),

и может быть отдельная цена для добавки (extra_price) — когда добавляется как extra.

При выборе вуншбола:

отображается на главной странице минимум (минимальная цена) для каждого типа/размера, рассчитанный автоматически на основе существующих продуктов: например, ABP (min) = MIN(price) среди протеинов, помеченных ABP.

в процессе составления: суммируются цены по ролям:

базовая цена выбранного размера (если есть),

цена выбранного протеина как компонент вуншбола (использовать extra_price, если выбран как добавка; иначе price если это основной выбор),

цена каждого extra берётся из extra_price поля соответствующего ингредиента.

В админке: каждое блюдо/ингредиент должен иметь флаги/поля:

is_protein (bool),

prices для разных размеров (маленький/стандарт) или price_small, price_standard,

extra_price — цена, если добавлено в extras.

При добавлении дополнительного протеина в extras — используется extra_price, а не price.

Корзина и отправка в Telegram должны содержать:

полное описание вуншбола: размер, протеин (с указанием, был ли это основной выбор или extra), база, соусы, список extras с их ценами и суммарной ценой.

итоговая сумма (в евро) и разбивка по позициям.

Что исправить в коде

Централизовать логику ценообразования в одном модуле/сервисе (pricingService.calculateWunschbowl(bowl)).

Проверить сериализацию корзины: при формировании заказа должно сохраняться все поля ингредиентов + цены.

Исправить баг, где при добавлении в корзину сумма обнуляется (вероятные причины: не сохраняются цены, неправильный сериализатор, float->int conversion).

Добавить unit/integration тесты:

Пример: если протеин курица price=9.50, extra_price=3.50, а клиент добавляет курица в extras, итоговая добавка должна давать +3.50, не +9.50.

Если добавлен протеин с price=3.00, то минимальная цена ABP должна быть 3.00.

Acceptance тесты (обязательно выполнить и описать результаты)

На главной странице отображается: ABP (min) — €X и Standard (min) — €Y, где X и Y — расчётные минимумы из существующих протеинов.

Состав вуншбола: добавить размер standard + protein A (price 3.00), extras: chicken (extra_price 3.50) -> итоговая сумма = base_size_price + 3.00 + 3.50. После добавления в корзину — сумма совпадает.

При отправке заказа в Telegram — в сообщении видно детальную разбивку: каждое extra с ценой и общий total.

5) Варианты/опции (вариации блюда)

Проблема: варианты (flavor, base) должны корректно отображаться и сохраняться.

Что сделать

Для каждого блюда в админке поддержать variants с полями: variant_id, name, price_modifier (если нужно), type (вкус/база).

На фронтенде: при выборе варианта — обновлять визуал и цену в реальном времени.

При добавлении в корзину — сохранять выбор варианта в записи заказа.

Отправка в Telegram — включать выбранные варианты в текст заказа.

Acceptance

Протестировать: покебол с 6 вариантами, выбрать базу X -> в корзине видно выбранную базу и её цена (или отсутствие изменения цены, если price_modifier=0) и в Telegram тоже.

6) Telegram-бот

Требуется: сообщения на немецком, подробная информация о заказе/резервации, точная передача состава и цен.

Что должно отправляться в Telegram

Для каждого заказа:

Номер/ID заказа,

Полный список позиций: название, варианты, база, все extras (каждый с ценой),

Количество каждого элемента,

Итоговая сумма (EUR),

Контактные данные (телефон, имя) и тип (резервация/доставка/самовывоз),

Время заказа, адрес/стол (если резервация).

Формат сообщения — читаемый, на немецком (предпочтительный шаблон), с точной дробной ценой (например, €9.50).

Логи: сохранять копию отправленного JSON/текста в БД для отладки.

Acceptance

Сделать тестовый заказ -> проверить сообщение в Telegram: всё поля есть, на немецком, цены соответствуют сумме.

7) Работоспособность на Railway (production)

Проблема: на Replit всё работает, на Railway — нет.

Проверить и исправить

Подтвердить, что Public/Main/Media синхронизируется и доступен в Railway (или настроить использование внешнего хранилища S3).

Убедиться, что пути к файлам — абсолютные URL/загружены в storage, а не относительные локальные пути, которые ломаются в prod.

БД: убедиться, что миграции применены на Railway; дампы/миграции запускаются при деплое.

ENV: document required ENV vars (DB_URL, STORAGE_URL, TELEGRAM_TOKEN и т.д.) и проверить их наличие.

Добавить health endpoint /health для проверки: DB connected, storage reachable, telegram reachable.

Acceptance

Деплой на Railway: все изображения загружаются, отображаются; добавление/редактирование в админке сохраняется и видно в prod.

8) Технические изменения в БД (рекомендации)

Таблицы/поля:

products : id, title, slug, price, extra_price, is_protein, image_path, variants (json).

orders : id, user_info (json), items (json), total_price, created_at.

snapshots : id, file_path, created_by, created_at.

Сериализация корзины: сохранять полные снимки каждого item (id, title, variant, price_at_time, extra_price_used).

9) Документация и отчёт

После выполнения — прислать отчёт в формате:

Что было изменено (список файлов/модулей).

Как работает новая логика (коротко).

Какие тесты вы провели и их результаты.

Что ещё можно улучшить (конкретные шаги).

Пошаговая инструкция для восстановления снэпшота и деплоя на Railway.

10) Тест-кейсы (обязательны, автоматические + ручные)

Unit: pricingService — тесты на расчёт суммы wunschbowl.

Integration: create_snapshot -> restore_snapshot -> сравнение состояния.

E2E ручные:

Добавить/переименовать изображение -> проверить отображение.

Собрать вуншбол с extras -> добавить в корзину -> отправить Telegram -> проверить содержимое и цену.

Настройки вариантов покеболов -> выбрать -> добавить -> проверить.

11) Критерии приёмки (final)

Снэпшоты: create/restore работают и восстанавливают состояние.

Изображения: все блюда имеют картинку, автопривязка по именам работает; на Railway картинка видна.

Вуншбол: цены рассчитываются корректно (основные/extra), в корзине и в Telegram указана полная разбивка и total > 0.

Варианты: выбор базы/вкуса сохраняется и отправляется.

Telegram: сообщения на немецком с полной информацией.

Документация: подробный отчёт и инструкция по деплою/восстановлению.

12) Формат ответа от разработчика (что прислать обратно)

Пожалуйста, пришлите:

Список изменений (файлы + краткое описание).

Ссылку на PR (Replit / Git).

Как тестировать (шаги).

Логи тестов и скриншоты/видео (если нужно).

Отчёт по каждому пункта из чек-листа (в формате: выполнено/не выполнено/комментарий).